<?php
/**
 * @file
 * Provides custom blocks for Backdropcms.org
 */

/**
 * Implements hook_block_info().
 */
function borg_blocks_block_info() {
  $blocks['branding'] = array(
    'info' => t('Branding'),
    'description' => t('Backdrop CMS logomark and wordmark.'),
  );
  $blocks['handbook'] = array(
    'info' => t('Handbook Menu'),
    'description' => t('Backdrop CMS Handbook menu, with section titles.'),
  );
  $blocks['rss'] = array(
    'info' => t('Project RSS feed'),
    'description' => t('RSS feed for Backdrop CMS modules, themes, and layouts.'),
  );
  $blocks['borg-social'] = array(
    'info' => t('Social Links Header - GitHub, Twitter, YouTube'),
    'description' => t('Site header links to social network Backdrop CMS accounts.'),
  );

  return $blocks;
}

/**
 * Implements function hook_block_view().
 */
function borg_blocks_block_view($delta = '', $settings = array(), $contexts = array()) {
  $block = array();

  switch ($delta) {
    case 'branding':
      $options = array('attributes' => array('class' => array('site-name')));
      $output = l(t('backdrop'), '', $options);

      $uri = backdrop_get_path('module', 'borg_blocks') . '/images/logo.png';
      $image = theme('image', array('uri' => $uri, 'alt' => t('Backdrop CMS Logo')));
      $options = array('html' => TRUE, 'attributes' => array('class' => array('logo'), 'title' => t('Backdrop CMS Home')));
      $output .= l($image, '', $options);

      $block['subject'] = NULL;
      $block['content'] = $output;
      break;

      case 'borg-social':
        $content = '
          <div class="borg-social">
            <a href="https://github.com/backdrop/backdrop-issues">
              <i class="fa fa-github" aria-hidden="true"></i>
            </a>
            <a href="https://twitter.com/backdropcms">
              <i class="fa fa-twitter" aria-hidden="true"></i>
            </a>
            <a href="https://www.youtube.com/user/backdropcms">
              <i class="fa fa-youtube" aria-hidden="true"></i>
            </a>
          </div>
        ';

        $block['subject'] = NULL;
        $block['content'] = $content;
        break;

    case 'handbook':
      $tree = menu_tree('menu-handbook');

      $block['subject'] = NULL;
      $block['content'] = backdrop_render($tree);
      break;

    case 'rss':
      $block['subject'] = NULL;
      $block['content'] = backdrop_get_feeds();
      break;
  }

  return $block;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * In https://github.com/backdrop/backdrop/commit/8977e8e8b191a2c7323d555ca486c248a0b55af0
 * we added the autofocus to the title of node and taxonomy add forms, but on the
 * front end when a node form is embeded in a block below the fold this is
 * undesirable; causing the page load to scroll down to that form element. In
 * this case the backdropcms.org homepage.
 */
function borg_blocks_form_supporter_node_form_alter(&$form, &$form_state, $form_id) {
  // Only unset for homepage.
  if (current_path() == 'node/19') {
    unset($form['title']['#attributes']['autofocus']);
  }
}
